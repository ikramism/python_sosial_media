<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <title>List Page</title>
    <style>
        body {
            font-family: "Montserrat", sans-serif !important;
            display: flex;
            justify-content: center;
            background-color: #f4f4f4;
        }
        .container {
            padding: 20px;
            width: 50%;
        }
        .contentBox {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        .userInput {
            width: 100%;
            height: 35px;
            text-align: center;
            background-color: #d8d8d8;
            border-radius: 35px;
            -webkit-border-radius: 35px;
            -moz-border-radius: 3.5px;
            -ms-border-radius: 3.5px;
            -o-border-radius: 3.5px;
            border: none;
            color: #303030;
            font-family: "Montserrat", sans-serif;
        }
        .btn {
            width: 70%;
            padding: 10px;
            background: #818589;;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }
        .btncolor {
            background-color: blue;
        }
        .previewContainer {
            display:none;
        }
        .deleteButton {
            height: 30px;
            width: 30px;
            border-radius: 20px;
            color: white;
            background-color: red;
            border: none;
            cursor: pointer;
        }
        .comment_text {
            width:92%;
            padding: 10px;
            border-radius: 15px;
            border-radius:15px;
            background-color:#d8d9dc;
            color:#65685C;
            display:flex;
            align-items: center;
        }
        .box1 {
            width:10%;
        }
        .box2 {
            width:90%;
        }
        .buttonUpload {
            width:20%;
        }
        .userIdBox {
            width:5%;
            border-radius:25px;
            width:40px;
            height:40px;
            
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .buttonPosition {
            text-align: right;
        }
        @media (max-width: 768px) {
            .buttonPosition {
                text-align: center;
            }
            .container {
                padding: 0px;
                width: 100%;
            }
            .contentBox {
                padding: 10px;
                width: 95%;
            }
            .box1 {
                width:15%;
            }
            .box2 {
                width:85%;
            }
            .buttonUpload {
                width:40%
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>News Feed</h2>
        <!-- Upload box -->
        <div class="contentBox">
            <div style="display:flex">
                <div class="box1">
                    <div style="border-radius:25px;width:40px;height:40px;background-color: grey;" class="userid"></div>
                </div>
                <div class="box2"><input class="userInput caption" type="text" placeholder="What's on your mind?" required oninput="verifyPost()"></div>
            </div>
            <div style="padding:5px"></div>
            <div>
                <div align="center">
                    <label for="photoUpload" style="cursor: pointer;">
                        <i class="fa-solid fa-image" style="font-size:15px"></i>
                        <span>Upload photo</span>
                    </label>
                    <input id="photoUpload" type="file" style="display: none;" accept="image/*">
                </div>
                <div class="previewContainer" style="margin-top: 10px;">
                    <div style="width:30%">Preview Photo:</div>
                    <img style="width:40%" id="photoPreview" src="" alt="Photo preview" style="display: none; max-width: 100%; max-height: 200px;">
                    <div style="width:30%;display:flex;justify-content: center;"><button class="deleteButton" type="button" onclick="deletephoto()">x</button></div>
                </div>
            </div>
            <div style="padding:5px"></div>
            <div class="buttonPosition">
                <button class="btn buttonUpload postbtn" type="button" onclick="uploadPost()" disabled="disabled">Upload</button>
            </div>
        </div>
        <div style="padding:20px"></div>
        <!-- Content List box -->
        <div class="postList">
            <div class="contentBox">
                <div style="display:flex">
                    <div style="width:5%;border-radius:25px;width:40px;height:40px;background-color: grey;" class="userid"></div>
                    <div class="poster-name" style="flex-direction:column;width:90%;display:flex;">
                        <div><span style="padding: 0px 5px"></span><span style="text-transform: capitalize;">Ikram Ismail</span></div>
                        <div style="font-size:0.7rem"><span style="padding: 0px 5px;color:#818589"></span><span>1 january 2024 10:53</span></div>
                    </div>

                    <div style="cursor:pointer;width:5%;display:flex;justify-content: center;position: relative;top:5px" onclick="deletePost()">
                        <i class="fa-solid fa-trash-can" style="font-size:1.1rem;color:blue"></i>
                    </div>
                </div>
                <div style="padding:5px"></div>
                <div style="padding:10px">Test caption</div>
                <div align="center">
                    <div style="width:90%;overflow:hidden;">
                        <img src="file:///C:/Users/Calvin/Desktop/Testing-Images/466389068_9391635294198469_4021892931608580017_n.jpg" style="width:100%;border-radius:15px"/>
                    </div>
                </div>
                <div style="padding:10px"></div>
                <div style="color:grey;font-size:1.2rem;">
                    <i class="fa-solid fa-comment"></i>
                    <span style="padding: 0px 5px">2</span>
                </div>
                <div style="padding:5px"></div>
                <!-- comment section -->
                <div>
                    <div style="display:flex;padding: 0px 10px">
                        <div style="width:10%">
                            <div style="border-radius:25px;width:40px;height:40px;background-color: grey;" class="posterid"></div>
                        </div>
                        <div style="width:85%">
                            <div style="text-transform: capitalize;font-size:1rem">ikram</div>
                            <div style="padding:5px"></div>
                            <div class="comment_text">Wow! good game. this is the best thing I ever see hahahhaha</div>
                        </div>
                        <div style="cursor:pointer;width:5%;display:flex;justify-content: center;align-items:center;position: relative;top:5px" onclick="deletecomment(1, this)">
                            <i class="fa-solid fa-trash-can" style="font-size:1.1rem"></i>
                        </div>
                    </div>
                    <div style="padding:5px"></div>
                </div>
                <!-- upload comment -->
                <div>
                    <div style="display:flex;padding: 0px 10px">
                        <div style="width:8%">
                            <div style="border-radius:25px;width:40px;height:40px;background-color: grey;" class="posterid"></div>
                        </div>
                        <div style="width: 92%;">
                            <input type="text" class="comment_text" style="width:95%;background-color: #f0f2f5;" placeholder="Add a comment"/>
                        </div>
                    </div>
                    <div style="padding:5px"></div>
                    <div style="text-align: right"><button class="btn btncolor" type="button" style="width:20%" onclick="commentPost(this)">Comment</button></div>
                </div>
            </div>
            <input type="hidden" value="1"/>
            <div style="padding:20px"></div>
        </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function () {
        $('#photoUpload').on('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('.previewContainer').css("display","flex");
                    $('#photoPreview').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
            }
        });
        
        // fetch all posts from api
        loadPostlist();
    });

    //foolproof upload
    function verifyPost() {
        let caption = $('.caption').val().trim();

        if (caption !== "") {
            $('.postbtn').addClass('btncolor').prop('disabled', false); // Enable button
        } else {
            $('.postbtn').removeClass('btncolor').prop('disabled', true); // Disable button
        }
    }
    async function loadPostlist() {
        try {
            const response = await $.ajax({
                url: "http://127.0.0.1:8000/post/list",
                type: "GET",
                headers: {
                    "Authorization": localStorage.getItem('authentication_key')
                }
            });
            $('.postList').hide();
            $('.postList').empty();

            for (const post of response.posts) {
                const postDate = new Date(post.date_created).toLocaleString('en-GB', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                });

                let deletePost = post.user_id == localStorage.getItem('user_id') ? `
                    <div style="cursor:pointer;width:5%;display:flex;justify-content: center;position: relative;top:5px" onclick="deletePost(${post.id}, this)">
                        <i class="fa-solid fa-trash-can" style="font-size:1.1rem;color:blue"></i>
                    </div>` : '';

                let imagePost = post.image ? `
                    <div align="center">
                        <div style="width:90%;overflow:hidden;">
                            <img src="${post.image}" style="width:100%;border-radius:15px"/>
                        </div>
                    </div>` : '';

                // Fetch and load comments for the post
                const { commentHtml, commentCount } = await commentList(post.id);

                const postHTML = `
                    <div class="contentBox">
                        <div style="display:flex">
                            <div class="userIdbox" class="userid">${post.user_id}</div>
                            <div class="poster-name" style="flex-direction:column;width:90%;display:flex;">
                                <div><span style="padding: 0px 5px"></span><span style="text-transform: capitalize;">${post.name}</span></div>
                                <div style="font-size:0.7rem"><span style="padding: 0px 5px;color:#818589"></span><span>${postDate}</span></div>
                            </div>`
                            + deletePost + `
                        </div>
                        <div style="padding:5px"></div>
                        <div style="padding:10px">${post.caption}</div>`
                        + imagePost + `
                        <div style="padding:10px"></div>
                        <div style="color:grey;font-size:1.2rem;"><i class="fa-solid fa-comment"></i><span style="padding: 0px 5px">${commentCount}</span></div>
                        <div style="padding:5px"></div>
                        <!-- Comments Section -->
                        <div>${commentHtml}</div>
                        <!-- Upload Comment -->
                        <div>
                            <div style="display:flex;padding: 0px 10px">
                                <div class="box1">
                                    <div style="border-radius:25px;width:40px;height:40px;background-color: grey;" class="posterid"></div>
                                </div>
                                <div class="box2">
                                    <input type="text" class="comment_text" style="width:95%;background-color: #f0f2f5;" placeholder="Add a comment"/>
                                </div>
                            </div>
                            <div style="padding:5px"></div>
                            <div style="text-align: right"><button class="btn btncolor buttonUpload" type="button" onclick="commentPost(this)">Comment</button></div>
                        </div>
                    </div>
                    <input type="hidden" value="${post.id}"/>
                    <div style="padding:20px"></div>
                `;

                // Append the post to the posts container
                $('.postList').append(postHTML);
            }
            $('.postList').fadeIn();
        } catch (error) {
            console.error("Error retrieving posts:", error);
            if (error.status === 401) {
                // Redirect to LoginPage.html
                window.location.href = "LoginPage.html";
            }
        }
    }

    function commentList(postId) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: `http://127.0.0.1:8000/comment/list?post_id=${postId}`,
                type: "GET",
                headers: {
                    "Authorization": localStorage.getItem('authentication_key')
                },
                success: function (response) {
                    let comment_list = '';
                    let commentCount = response.comments.length;

                    $.each(response.comments, function(index, comment) {
                        let deleteCom = '';
                        if (comment.user_id == localStorage.getItem('user_id')) {
                            deleteCom = `<div style="cursor:pointer;width:5%;display:flex;justify-content: center;align-items:center;position: relative;top:5px" onclick="deletecomment(${comment.id}, this)">
                                            <i class="fa-solid fa-trash-can" style="font-size:1.1rem"></i>
                                        </div>`;
                        }

                        comment_list += `<div class="commentPost${postId}">
                                            <div style="display:flex;padding: 0px 10px">
                                                <div style="width:10%;padding:5px">
                                                    <div style="border-radius:25px;width:40px;height:40px;background-color: grey;" class="posterid"></div>
                                                </div>
                                                <div style="width:85%;padding:5px">
                                                    <div style="text-transform: capitalize;font-size:1rem">${comment.name}</div>
                                                    <div style="padding:5px"></div>
                                                    <div class="comment_text">${comment.text}</div>
                                                </div>`
                                                + deleteCom +
                                            `</div>
                                            <div style="padding:5px"></div>
                                        </div>`;
                    });

                    resolve({ commentHtml: comment_list, commentCount });
                },
                error: function (xhr, status, error) {
                    console.error("Error retrieving comments:", xhr.responseText);
                    reject(error);
                }
            });
        });
    }

    function uploadPost() {
        // declare all the inputs to be send to api
        const caption = $('.caption').val().trim();
        const userId = localStorage.getItem('user_id')
        const fileInput = document.getElementById('photoUpload');
        const file = fileInput.files[0];

        // Create a FormData object
        const formData = new FormData();
        formData.append("caption", caption);
        formData.append("user_id", userId);

        // if picture is available assign value to it.
        if (file) {
            formData.append("photo", file); 
        }

        // Send the data to the server via AJAX
        $.ajax({
            url: "http://127.0.0.1:8000/post/upload", // API endpoint
            type: "POST",
            headers: {
                Authorization: localStorage.getItem('authentication_key'), // Add auth token
            },
            data: formData,
            processData: false,
            contentType: false, 
            success: function (response) {
                // Clear the form after successful upload
                $('.caption').val('');
                $('.previewContainer').css("display","none");
                fileInput.value = ''; // Reset the file input
                $('.postbtn').removeClass('btncolor').prop('disabled', true);
                loadPostlist();
            },
            error: function (xhr, status, error) {
                alert("Error uploading post: " + xhr.responseText);
                console.error(error);
            },
        });
    }
    
    function commentPost(element) {
        let postId=$(element).parent().parent().parent().next().val();
        let commentText = $(element).parent().prev().prev().children().next().children().val();
        let commentData = {
            post_id : postId,
            user_id : localStorage.getItem('user_id'),
            comment : commentText,
        };

        $.ajax({
            url: "http://127.0.0.1:8000/post/comment", // FastAPI endpoint
            type: "POST",
            contentType: "application/json",
            headers: {
                "Authorization": localStorage.getItem('authentication_key')  // Correctly include the authorization header
            },
            data: JSON.stringify(commentData),

            success: function (response) {
                loadPostlist();
            },
            error: function (xhr, status, error) {
            }
        });
    }

    function deletecomment(commentId, element) {
        let commentData = {
            comment_id : commentId,
        };
        // hide comment and update new comment numbers
        $(element).parent().parent().fadeOut(function () {
            // After fading out, count the visible children
            let newNumber = $(element).parent().parent().parent().children().filter(function () {
                return $(this).css('display') !== 'none';
            }).length;

            $(element).parent().parent().parent().prev().prev().children().next().html(newNumber);
        });
        
        $.ajax({
            url: "http://127.0.0.1:8000/comment/delete", // FastAPI endpoint
            type: "POST",
            contentType: "application/json",
            headers : {
                "Authorization": localStorage.getItem('authentication_key')
            },
            data: JSON.stringify(commentData),

            success: function (response) {
                // delete the comment
                $(element).parent().parent().fadeOut();
            },
            error: function (xhr, status, error) {
            }
        });
    }

    function deletePost(postId, element) {
        let postData = {
            post_id : postId
        };

        $(element).parent().parent().next().next().fadeOut();
        $(element).parent().parent().next().fadeOut();
        $(element).parent().parent().fadeOut();
        $.ajax({
            url: "http://127.0.0.1:8000/post/delete", // FastAPI endpoint
            type: "POST",
            contentType: "application/json",
            headers: {
                "Authorization": localStorage.getItem('authentication_key')  // Correctly include the authorization header
            },
            data: JSON.stringify(postData),

            success: function (response) {
                $(element).parent().parent().fadeOut();
            },
            error: function (xhr, status, error) {
            }
        });
    }

    function deletephoto() {
        const fileInput = $('#photoUpload').val();
        console.log('ikram')
        fileInput.value = ''; // Reset the file input
        $('.previewContainer').css("display","none");
    }
</script>
</html>
